<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.0/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    <a-scene>
      <a-assets>
        <img id="ciel" src="asset/Ciel.png" />
        <a-asset-item id="sable" src="asset/Sable.glb"></a-asset-item>
        <a-asset-item id="mairie" src="asset/mairie.glb"></a-asset-item>
        <a-asset-item id="maison" src="asset/dome.glb"></a-asset-item>
        <a-asset-item id="sable" src="asset/sable.glb"></a-asset-item>
        <a-asset-item id="r2d2" src="asset/droide1.glb"></a-asset-item>
        <a-asset-item id="ATST" src="asset/ATST.glb"></a-asset-item>
        <a-asset-item id="destroyer" src="asset/destroyer.glb"></a-asset-item>
        <a-asset-item id="k2so" src="asset/droide2.glb"></a-asset-item>
      </a-assets>
      <a-sky
        src="#ciel"
        position="-50 -50 -50"
        material="opacity: 0.85"
      ></a-sky>
      <a-entity gltf-model="#sable" position="0 0 0" scale="1 1 1"></a-entity>
      <a-entity
        gltf-model="#maison"
        position="3.394 0 -0.970"
        rotation="0 0 0"
      ></a-entity>

      <a-entity
        gltf-model="#maison"
        position="10 0 -0.970"
        rotation="0 0 0"
      ></a-entity>

      <a-entity
        gltf-model="#maison"
        position="16.606 0 -0.970"
        rotation="0 0 0"
      ></a-entity>

      <a-entity
        gltf-model="#mairie"
        position="15.566 1.318 20.211"
        rotation="0 90 0"
      ></a-entity>

      <a-entity
        gltf-model="#r2d2"
        position="16.607 0 17.250"
        rotation="0 -180 0"
      ></a-entity>

      <!-- Modèle animé k2so avec mouvement -->
      <a-entity
        id="k2so"
        gltf-model="#k2so"
        position="16.607 0 17.250"
        rotation="0 -180 0"
        animation-mixer
      ></a-entity>

      <a-entity
        gltf-model="#ATST"
        position="3.164 0 10.590"
        rotation="0 0 0"
        scale="0.025 0.025 0.025"
      ></a-entity>

      <a-entity
        gltf-model="#destroyer"
        position="-245.467 139.592 20.820"
        rotation="-20 -90 0"
        scale="20 20 20"
      ></a-entity>

      <a-sphere
        position="24.723 3.833 581.876"
        radius="10"
        scale="10 10 10"
        color="#FEE893"
      ></a-sphere>
      <a-sphere
        position="162.861 220.308 533.432"
        radius="10"
        scale="5 5 5"
        color="#FB8C78"
      ></a-sphere>
      <a-camera position="0 1 0"></a-camera>
    </a-scene>

    <script>
      AFRAME.registerComponent('move-k2so', {
        schema: {
          points: { type: 'array', default: [[16.607, 0, 17.250], [20, 0, 20], [25, 0, 25]] },
          duration: { type: 'number', default: 3000 },
          stopDuration: { type: 'number', default: 2000 },
        },
        init: function () {
          this.currentPoint = 0; // Index du point de départ
          this.isMoving = false;
          this.moveToNextPoint();
        },
        moveToNextPoint: function () {
          if (this.isMoving) return; // Évite d'exécuter plusieurs fois en parallèle
          this.isMoving = true;

          const el = this.el;
          const points = this.data.points;
          const current = points[this.currentPoint];
          const next = points[(this.currentPoint + 1) % points.length];

          const duration = this.data.duration;
          const stopDuration = this.data.stopDuration;

          el.setAttribute('animation__move', {
            property: 'position',
            to: `${next[0]} ${next[1]} ${next[2]}`,
            dur: duration,
            easing: 'linear',
          });

          // Attend que le mouvement soit terminé
          setTimeout(() => {
            this.isMoving = false;
            this.currentPoint = (this.currentPoint + 1) % points.length;

            // Arrêt entre les mouvements
            setTimeout(() => {
              this.moveToNextPoint();
            }, stopDuration);
          }, duration);
        },
      });

      AFRAME.registerComponent('animate-k2so', {
        init: function () {
          this.el.addEventListener('model-loaded', () => {
            this.startWalking();
          });
        },
        startWalking: function () {
          const el = this.el;
          const mixer = el.getObject3D('mesh').mixer;
          const walkAction = mixer.clipAction('Walk');
          const idleAction = mixer.clipAction('Idle');

          walkAction.setLoop(THREE.LoopOnce);
          idleAction.setLoop(THREE.LoopOnce);

          const walkDuration = 2000; // Durée de la marche en millisecondes
          const idleDuration = 2000; // Durée de l'arrêt en millisecondes

          const walkAndIdle = () => {
            walkAction.reset().play();
            el.emit('walk');

            setTimeout(() => {
              walkAction.stop();
              idleAction.reset().play();
              el.emit('idle');

              setTimeout(() => {
                idleAction.stop();
                walkAndIdle();
              }, idleDuration);
            }, walkDuration);
          };

          walkAndIdle();
        }
      });

      document.querySelector('#k2so').setAttribute('move-k2so', {
        points: [[16.607, 0, 17.250], [20, 0, 20], [25, 0, 25]],
        duration: 3000,
        stopDuration: 2000,
      });

      document.querySelector('#k2so').setAttribute('animate-k2so', '');
    </script>
  </body>
</html>